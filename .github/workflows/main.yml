name: ðŸš€ SERVER vanmanhgaming

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '1_Giá»_30_PhÃºt_(90m)'
        type: choice
        options:
          - '30_PhÃºt_(30m)'
          - '1_Giá»_(60m)'
          - '1_Giá»_30_PhÃºt_(90m)'
          - '2_Giá»_(120m)'
          - '2_Giá»_30_PhÃºt_(150m)'
          - '3_Giá»_(180m)'
          - '3_Giá»_30_PhÃºt_(210m)'
          - '4_Giá»_(240m)'
          - '4_Giá»_30_PhÃºt_(270m)'
          - '5_Giá»_(300m)'
          - '5_Giá»_30_PhÃºt_(330m)'
          - '6_Giá»_(360m)'
          - '30_NgÃ y_(43200m)'
          - '60_NgÃ y_(86400m)'
          - '90_NgÃ y_(129600m)'

jobs:
  Vanmanhgaming-RDP-Setup:
    runs-on: windows-latest
    steps:
      # BANNER CHÃ€O Má»ªNG
      - name: KHá»žI Äá»˜NG Há»† THá»NG
        shell: powershell
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          $OutputEncoding = [System.Text.Encoding]::UTF8
          chcp 65001 > $null
          
          Write-Host "`n vanmanhgaming RDP SERVER" -ForegroundColor Yellow
          Write-Host " Powered by vanmanhgaming" -ForegroundColor Green
          Write-Host " Thá»i gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta

      # Cáº¤U HÃŒNH Há»† THá»NG
      - name: Cáº¤U HÃŒNH Há»† THá»NG
        shell: powershell
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389
          netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389
          Set-Service -Name TermService -StartupType Automatic
          Start-Service TermService
          Write-Host " Cáº¥u hÃ¬nh RDP hoÃ n táº¥t" -ForegroundColor Green

      # Táº O USER PREMIUM - (tá»‘i Æ°u máº­t kháº©u)
      - name: ðŸ‘¤ Táº O TÃ€I KHOáº¢N PREMIUM
        run: |
          Write-Host ""
          Write-Host "ðŸ‘¤ ÄANG Táº O TÃ€I KHOáº¢N vanmanhgaming" -ForegroundColor Yellow
          
          # HÃ m táº¡o password ngáº¯n (8 kÃ½ tá»±) Ä‘áº£m báº£o cÃ³ Ã­t nháº¥t 1 chá»¯ hoa, 1 chá»¯ thÆ°á»ng, 1 sá»‘
          function New-PremiumPassword {
              param()
              $upper = 'ABCDEFGHJKLMNPQRSTUVWXYZ'   # loáº¡i I,O Ä‘á»ƒ trÃ¡nh nháº§m
              $lower = 'abcdefghijkmnpqrstuvwxyz'
              $numbers = '23456789'               # loáº¡i 0,1 Ä‘á»ƒ trÃ¡nh nháº§m
              $all = $upper + $lower + $numbers

              # Ä‘áº£m báº£o 1 chá»¯ hoa, 1 chá»¯ thÆ°á»ng, 1 chá»¯ sá»‘
              $pw = ''
              $pw += $upper[(Get-Random -Minimum 0 -Maximum $upper.Length)]
              $pw += $lower[(Get-Random -Minimum 0 -Maximum $lower.Length)]
              $pw += $numbers[(Get-Random -Minimum 0 -Maximum $numbers.Length)]

              # thÃªm kÃ½ tá»± ngáº«u nhiÃªn Ä‘á»ƒ Ä‘á»§ 8 kÃ½ tá»±
              for ($i = 1; $i -le 5; $i++) {
                  $pw += $all[(Get-Random -Minimum 0 -Maximum $all.Length)]
              }

              # trá»™n ngáº«u nhiÃªn vá»‹ trÃ­ cÃ¡c kÃ½ tá»± rá»“i tráº£ vá»
              return -join ($pw.ToCharArray() | Sort-Object { Get-Random })
          }

          # Náº¿u ngÆ°á»i dÃ¹ng Ä‘áº·t máº­t kháº©u tÃ¹y chá»‰nh (vÃ­ dá»¥ báº±ng secret) thÃ¬ Æ°u tiÃªn dÃ¹ng
          if ($env:CUSTOM_RDP_PASS) {
              $matKhau = $env:CUSTOM_RDP_PASS
              Write-Host "â”‚ â„¹ï¸  DÃ¹ng máº­t kháº©u tÃ¹y chá»‰nh tá»« env" -ForegroundColor Blue
          } else {
              $matKhau = New-PremiumPassword
          }

          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force
          
          # XÃ³a user cÅ© náº¿u tá»“n táº¡i
          try {
              Remove-LocalUser -Name "vanmanhgaming" -ErrorAction SilentlyContinue
              Write-Host "â”‚ âœ… ÄÃ£ xÃ³a user cÅ©" -ForegroundColor Green
          } catch {
              Write-Host "â”‚ â„¹ï¸  KhÃ´ng cÃ³ user cÅ© Ä‘á»ƒ xÃ³a" -ForegroundColor Blue
          }
          
          # Táº¡o user má»›i vá»›i Ä‘áº§y Ä‘á»§ quyá»n
          try {
              New-LocalUser -Name "vanmanhgaming" -Password $securePass -AccountNeverExpires -Description "vanmanhgaming Premium Account"
              Write-Host "â”‚ âœ… ÄÃ£ táº¡o user má»›i" -ForegroundColor Green
              
              # Äáº·t password khÃ´ng bao giá» háº¿t háº¡n (dÃ¹ng Set-LocalUser náº¿u cáº§n)
              try {
                  Set-LocalUser -Name "vanmanhgaming" -PasswordNeverExpires $true -ErrorAction SilentlyContinue
              } catch {
                  # Náº¿u mÃ´i trÆ°á»ng khÃ´ng há»— trá»£ Set-LocalUser, bá» qua an toÃ n
              }

              # ThÃªm vÃ o cÃ¡c nhÃ³m cáº§n thiáº¿t
              Add-LocalGroupMember -Group "Administrators" -Member "vanmanhgaming" -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "vanmanhgaming" -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group "Users" -Member "vanmanhgaming" -ErrorAction SilentlyContinue
              
              # KÃ­ch hoáº¡t user
              Enable-LocalUser -Name "vanmanhgaming"
              
              Write-Host "â”‚ âœ… ÄÃ£ cáº¥p quyá»n Administrator & RDP" -ForegroundColor Green
              
          } catch {
              Write-Host "â”‚ âŒ Lá»—i táº¡o user: $($_.Exception.Message)" -ForegroundColor Red
              exit 1
          }
          
          # LÆ°u thÃ´ng tin (cáº©n trá»ng náº¿u repo public)
          echo "RDP_USER=vanmanhgaming" >> $env:GITHUB_ENV
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV
          echo "$matKhau" > $env:TEMP\rdp_password.txt
          
          Write-Host "âœ… TÃ i khoáº£n: vanmanhgaming Ä‘Ã£ sáºµn sÃ ng" -ForegroundColor Green

      # TAILSCALE PREMIUM
      - name: ðŸŒ THIáº¾T Láº¬P Máº NG PREMIUM
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host ""
          Write-Host "ðŸŒ ÄANG THIáº¾T Láº¬P Káº¾T Ná»I Máº NG" -ForegroundColor Yellow
          
          # CÃ i Ä‘áº·t Tailscale
          try {
              $msiPath = "$env:TEMP\tailscale-premium.msi"
              Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
              Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
              Remove-Item $msiPath -Force -ErrorAction SilentlyContinue
              Write-Host "â”‚ âœ… CÃ i Ä‘áº·t Tailscale thÃ nh cÃ´ng" -ForegroundColor Green
          } catch {
              Write-Host "â”‚ âŒ Lá»—i cÃ i Ä‘áº·t Tailscale" -ForegroundColor Red
          }
          
          # Chá» dá»‹ch vá»¥ khá»Ÿi Ä‘á»™ng
          Start-Sleep -Seconds 10
          
          # Káº¿t ná»‘i Tailscale
          try {
              & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=vanmanhgaming-premium-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
              Write-Host "â”‚ âœ… Káº¿t ná»‘i Tailscale thÃ nh cÃ´ng" -ForegroundColor Green
          } catch {
              Write-Host "â”‚ âŒ Lá»—i káº¿t ná»‘i Tailscale" -ForegroundColor Red
          }
          
          # Láº¥y IP vá»›i retry mechanism
          Write-Host "ðŸ”„ Äang láº¥y Ä‘á»‹a chá»‰ IP..." -NoNewline -ForegroundColor Blue
          $ip = $null
          for($i=0; $i -lt 20; $i++) {
              try {
                  $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1
                  if ($ip -and $ip -match '^\d+\.\d+\.\d+\.\d+$') {
                      echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
                      Write-Host "`râœ… Äá»‹a chá»‰ IP: $ip" -ForegroundColor Green
                      break
                  }
              } catch {
                  # Bá» qua lá»—i vÃ  thá»­ láº¡i
              }
              Write-Host "`rðŸ”„ Äang láº¥y Ä‘á»‹a chá»‰ IP... $(@('.', '..', '...')[$i % 3])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Seconds 3
          }
          
          if (-not $ip -or $ip -notmatch '^\d+\.\d+\.\d+\.\d+$') {
              Write-Host "`râš ï¸  KhÃ´ng thá»ƒ láº¥y IP, sá»­ dá»¥ng localhost" -ForegroundColor Yellow
              echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV
          }

      - name: ðŸŒ KIá»‚M TRA Káº¾T Ná»I Äáº¾N TAILSCALE
        run: |
          # KÃ­ch hoáº¡t Tailscale báº±ng Auth Key vÃ  Ä‘áº·t tÃªn mÃ¡y theo ID cá»§a GitHub Runner
          Write-Host "ðŸ”§ Äang khá»Ÿi táº¡o Tailscale..."
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID

          # Chá» Tailscale cáº¥p Ä‘á»‹a chá»‰ IP
          Write-Host "â³ Äang chá» Tailscale cáº¥p IP..."
          $tsIP = $null
          $retries = 0

          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }

          # Náº¿u khÃ´ng láº¥y Ä‘Æ°á»£c Ä‘á»‹a chá»‰ IP thÃ¬ bÃ¡o lá»—i vÃ  thoÃ¡t
          if (-not $tsIP) {
              Write-Error "âŒ KhÃ´ng thá»ƒ láº¥y Ä‘á»‹a chá»‰ IP tá»« Tailscale. Dá»«ng tiáº¿n trÃ¬nh."
              exit 1
          }

          Write-Host "âœ… ÄÃ£ nháº­n IP Tailscale: $tsIP" -ForegroundColor Green

          # Xuáº¥t IP sang biáº¿n mÃ´i trÆ°á»ng Ä‘á»ƒ dÃ¹ng á»Ÿ bÆ°á»›c tiáº¿p theo
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      # KIá»‚M TRA Káº¾T Ná»I RDP
      - name: KIá»‚M TRA Káº¾T Ná»I RDP
        shell: pwsh
        run: |
          Write-Host " Äá»‹a chá»‰ Tailscale: $env:TAILSCALE_IP"
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
          if (-not $testResult.TcpTestSucceeded) {
              Write-Error " KhÃ´ng thá»ƒ káº¿t ná»‘i TCP Ä‘áº¿n cá»•ng RDP (3389)."
              exit 1
          }

     # Dá»ŒN Dáº¸P
      - name: ðŸ§¹ Dá»ŒN Dáº¸P FILE Táº M
        if: always()
        run: |
          Remove-Item "$env:TEMP\rdp_password.txt" -Force -ErrorAction SilentlyContinue
          Write-Host "ðŸ§¹ ÄÃ£ dá»n dáº¹p file táº¡m thÃ nh cÃ´ng!" -ForegroundColor Green

      # HIá»‚N THá»Š GIAO DIá»†N Äáº¸P
      - name: ðŸŽ‰ THÃ”NG TIN Káº¾T Ná»I
        run: |
          # Láº¥y máº­t kháº©u tá»« biáº¿n mÃ´i trÆ°á»ng (Ä‘Æ°á»£c thiáº¿t láº­p trong bÆ°á»›c táº¡o user)
          $matKhau = $env:RDP_PASS
          if (-not $matKhau) {
              $matKhau = "KhÃ´ng thá»ƒ Ä‘á»c máº­t kháº©u"
          }
          
          # Chuyá»ƒn Ä‘á»•i thá»i gian tá»« input sang phÃºt
          $durationInput = "${{ github.event.inputs.duration }}"
          switch ($durationInput) {
              "30_PhÃºt_(30m)"              { $totalMinutes = 30;  $displayTime = "30 phÃºt" }
              "1_Giá»_(60m)"                { $totalMinutes = 60;  $displayTime = "1 giá»" }
              "1_Giá»_30_PhÃºt_(90m)"        { $totalMinutes = 90;  $displayTime = "1 giá» 30 phÃºt" }
              "2_Giá»_(120m)"               { $totalMinutes = 120; $displayTime = "2 giá»" }
              "2_Giá»_30_PhÃºt_(150m)"       { $totalMinutes = 150; $displayTime = "2 giá» 30 phÃºt" }
              "3_Giá»_(180m)"               { $totalMinutes = 180; $displayTime = "3 giá»" }
              "3_Giá»_30_PhÃºt_(210m)"       { $totalMinutes = 210; $displayTime = "3 giá» 30 phÃºt" }
              "4_Giá»_(240m)"               { $totalMinutes = 240; $displayTime = "4 giá»" }
              "4_Giá»_30_PhÃºt_(270m)"       { $totalMinutes = 270; $displayTime = "4 giá» 30 phÃºt" }
              "5_Giá»_(300m)"               { $totalMinutes = 300; $displayTime = "5 giá»" }
              "5_Giá»_30_PhÃºt_(330m)"       { $totalMinutes = 330; $displayTime = "5 giá» 30 phÃºt" }
              "6_Giá»_(360m)"               { $totalMinutes = 360; $displayTime = "6 giá»" }
              "30_NgÃ y_(43200m)"           { $totalMinutes = 43200; $displayTime = "30 ngÃ y" }
              "60_NgÃ y_(86400m)"           { $totalMinutes = 86400; $displayTime = "60 ngÃ y" }
              "90_NgÃ y_(129600m)" { $totalMinutes = 129600; $displayTime = "90 ngÃ y" }
          }
          
          # TÃ­nh thá»i gian chÃ­nh xÃ¡c
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $thoiGianKetThuc = $thoiGianBatDau.AddMinutes($totalMinutes)
          
          Write-Host ""
          Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
          Write-Host "â”‚              ðŸŽ‰ Káº¾T Ná»I THÃ€NH CÃ”NG!              â”‚" -ForegroundColor Cyan
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Cyan
          Write-Host "â”‚ ðŸŒ  Äá»‹a chá»‰: $env:TAILSCALE_IP" -ForegroundColor White
          Write-Host "â”‚ ðŸ‘¤  TÃ i khoáº£n: vanmanhgaming" -ForegroundColor White
          Write-Host "â”‚ ðŸ”  Máº­t kháº©u: $matKhau" -ForegroundColor White
          Write-Host "â”‚ â°  Thá»i lÆ°á»£ng: $displayTime" -ForegroundColor White
          Write-Host "â”‚ ðŸ•  Báº¯t Ä‘áº§u: $($thoiGianBatDau.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "â”‚ ðŸ•  Káº¿t thÃºc: $($thoiGianKetThuc.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "â”‚ ðŸ“  Port: 3389" -ForegroundColor White
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Cyan
          Write-Host "â”‚ ðŸ’¡  HÆ°á»›ng dáº«n:                                     â”‚" -ForegroundColor Cyan
          Write-Host "â”‚   1. Má»Ÿ Remote Desktop Connection                  â”‚" -ForegroundColor Yellow
          Write-Host "â”‚   2. Nháº­p: $env:TAILSCALE_IP                       â”‚" -ForegroundColor Yellow
          Write-Host "â”‚   3. User: vanmanhgaming | Password: trÃªn          â”‚" -ForegroundColor Yellow
          Write-Host "â”‚   4. Done VPS Rá»“i Nha CÃ¡c TÃ¬nh YÃªu! ðŸš€             â”‚" -ForegroundColor Yellow
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Cyan
          
          # LÆ°u thá»i gian vÃ o biáº¿n mÃ´i trÆ°á»ng
          echo "TOTAL_MINUTES=$totalMinutes" >> $env:GITHUB_ENV

        # DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C á»”N Äá»ŠNH VÃ  90 ngÃ y / 24/7
      - name: â³ DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C
        shell: pwsh
        run: |
            $totalMinutes = [int]$env:TOTAL_MINUTES
            $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
            $startTime = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
            $endTime = $startTime.AddMinutes($totalMinutes)
            Write-Host ""
            Write-Host "ðŸ”„ Báº®T Äáº¦U DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C..." -ForegroundColor Yellow
            Write-Host "ðŸ’Ž PhiÃªn: $env:RDP_USER" -ForegroundColor Magenta
            Write-Host "ðŸ”— Káº¿t ná»‘i: $env:TAILSCALE_IP" -ForegroundColor Cyan
            Write-Host "ðŸ• Báº¯t Ä‘áº§u: $($startTime.ToString('dd/MM/yyyy HH:mm:ss'))" -ForegroundColor Green
            Write-Host "ðŸ• Káº¿t thÃºc: $($endTime.ToString('dd/MM/yyyy HH:mm:ss'))" -ForegroundColor Green
            Write-Host ""
            # GiÃ¡m sÃ¡t TermService
            $monitorScript = {
                while ($true) {
                    $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                    if ($termService.Status -ne 'Running') { Start-Service -Name TermService -ErrorAction SilentlyContinue }
                    Start-Sleep -Seconds 30
                }
            }
            Start-Job -ScriptBlock $monitorScript -Name "SystemMonitor"
            # Kiá»ƒm tra 24/7 chá»‰ khi TOTAL_MINUTES >= 43200
            $infiniteRun = $totalMinutes -ge 43200
            do {
                $currentTime = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
                $timeLeft = $endTime - $currentTime
                $days = [math]::Max(0, [math]::Floor($timeLeft.TotalDays))
                $hours = [math]::Max(0, [math]::Floor($timeLeft.TotalHours % 24))
                $minutes = [math]::Max(0, [math]::Floor($timeLeft.TotalMinutes % 60))
                $seconds = [math]::Max(0, [math]::Floor($timeLeft.TotalSeconds % 60))
                if ($infiniteRun) {
                    Write-Host ("ðŸŸ¢ Cháº¿ Ä‘á»™ 24/7 Ä‘ang cháº¡y... Thá»i gian cÃ²n láº¡i: {0} ngÃ y {1} giá» {2} phÃºt {3} giÃ¢y" -f $days, $hours, $minutes, $seconds) -ForegroundColor Green
                } else {
                    Write-Host ("â³ Thá»i gian cÃ²n láº¡i: {0} ngÃ y {1} giá» {2} phÃºt {3} giÃ¢y" -f $days, $hours, $minutes, $seconds) -ForegroundColor Cyan
                }
                Start-Sleep -Seconds 5
            } while ($infiniteRun -or $timeLeft.TotalSeconds -gt 0)
            Write-Host "ðŸŽ¯ ÄÃƒ Háº¾T THá»œI GIAN - Tá»° Äá»˜NG Dá»ªNG!" -ForegroundColor Red
            # Dá»n dáº¹p Job giÃ¡m sÃ¡t
            Get-Job -Name "SystemMonitor" -ErrorAction SilentlyContinue | Stop-Job -PassThru | Remove-Job -Force

      # Dá»ŒN Dáº¸P CUá»I CÃ™NG
      - name: Dá»ŒN Dáº¸P Há»† THá»NG
        if: always()
        shell: powershell
        run: |
          Write-Host ""
          Write-Host " ÄANG Dá»ŒN Dáº¸P Há»† THá»NG..." -ForegroundColor Yellow

          try { Disable-LocalUser -Name "vanmanhgaming" -ErrorAction SilentlyContinue } catch {}

          try {
              & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all
              Start-Sleep -Seconds 5
          } catch {}

          try {
              netsh advfirewall firewall delete rule name="RDP-Premium" 2>$null
              netsh advfirewall firewall delete rule name="RDP-Premium-Out" 2>$null
              Remove-NetFirewallRule -DisplayName "RDP-Premium" -ErrorAction SilentlyContinue
              Remove-NetFirewallRule -DisplayName "RDP-Premium-Out" -ErrorAction SilentlyContinue
          } catch {}

          try {
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force
              Stop-Service -Name TermService -Force -ErrorAction SilentlyContinue
          } catch {}

          Get-Job | Stop-Job -PassThru | Remove-Job -Force -ErrorAction SilentlyContinue

          Write-Host " Dá»n dáº¹p hoÃ n táº¥t! Háº¹n gáº·p láº¡i! " -ForegroundColor Green              Number  = [char[]](48..57)      # 0-9
              Special = ([char[]](33..47) + [char[]](58..64) +
                         [char[]](91..96) + [char[]](123..126)) # Special characters
          }
          $rawPassword = @()
          $rawPassword += $charSet.Upper | Get-Random -Count 4
          $rawPassword += $charSet.Lower | Get-Random -Count 4
          $rawPassword += $charSet.Number | Get-Random -Count 4
          $rawPassword += $charSet.Special | Get-Random -Count 4
          $password = -join ($rawPassword | Sort-Object { Get-Random })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "may ao 6h" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "may ao 6h"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "may ao 6h"
          
          echo "RDP_CREDS=User: may ao 6h | Password: $password" >> $env:GITHUB_ENV
          
          if (-not (Get-LocalUser -Name "may ao 6h")) {
              Write-Error "User creation failed"
              exit 1
          }

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Establish Tailscale Connection
        run: |
          # Bring up Tailscale with the provided auth key and set a unique hostname
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID
          
          # Wait for Tailscale to assign an IP
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }
          
          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned. Exiting."
              exit 1
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
      
      - name: Verify RDP Accessibility
        run: |
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          
          # Test connectivity using Test-NetConnection against the Tailscale IP on port 3389
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
          if (-not $testResult.TcpTestSucceeded) {
              Write-Error "TCP connection to RDP port 3389 failed"
              exit 1
          }
          Write-Host "TCP connectivity successful!"

      - name: Maintain Connection
        run: |
          Write-Host "`n=== RDP ACCESS ==="
          Write-Host "Address: $env:TAILSCALE_IP"
          Write-Host "Username: may ao 6h"
          Write-Host "Password: $(echo $env:RDP_CREDS)"
          Write-Host "==================`n"
          
          # Keep runner active indefinitely (or until manually cancelled)
          while ($true) {
              Write-Host "[$(Get-Date)] RDP Active - Use Ctrl+C in workflow to terminate"
              Start-Sleep -Seconds 300
          }
